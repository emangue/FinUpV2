# ==========================================
# DEPLOY FINAL - Sistema FinanÃ§as V4
# ==========================================
# Execute estes comandos DIRETAMENTE no servidor via SSH
# ssh root@148.230.78.91

# 1. VERIFICAR ESTRUTURA
cd /var/www/financas/app_dev
pwd
ls -la

# 2. BACKEND - PREPARAR AMBIENTE
cd backend
source venv/bin/activate
pip list | grep fastapi
echo "âœ… Python ambiente OK"

# 3. TESTAR CONFIGURAÃ‡ÃƒO
python -c "
from app.core.config import settings
print(f'Database: {settings.DATABASE_PATH}')
print(f'Host: {settings.HOST}:{settings.PORT}')
print(f'Secret: {settings.SECRET_KEY[:10]}...')
print('âœ… Config OK')
"

# 4. VERIFICAR BANCO
ls -la /var/lib/financas/db/financas.db 2>/dev/null && echo "âœ… Database exists" || echo "âŒ Database missing"

# 5. TESTE RÃPIDO DA APLICAÃ‡ÃƒO
python -c "
from app.main import app
from app.core.database import SessionLocal
print('âœ… App imports OK')
"

# 6. INICIAR BACKEND (modo daemon)
pkill -f uvicorn 2>/dev/null || true
nohup python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > /var/log/financas-backend.log 2>&1 &
echo "âœ… Backend started - PID: $!"

# 7. AGUARDAR BACKEND SUBIR
sleep 3
curl -s http://localhost:8000/api/health | head -20
echo ""

# 8. FRONTEND - PREPARAR
cd ../frontend
echo "ğŸ“¦ Verificando Node.js..."
node -v
npm -v

# 9. INSTALAR DEPENDÃŠNCIAS SE NECESSÃRIO
if [ ! -d "node_modules" ]; then
    echo "ğŸ“¦ Instalando dependÃªncias..."
    npm install
else
    echo "âœ… Dependencies exist"
fi

# 10. BUILD FRONTEND
echo "ğŸ”§ Building frontend..."
npm run build

# 11. INICIAR FRONTEND
pkill -f "next start" 2>/dev/null || true
nohup npm start > /var/log/financas-frontend.log 2>&1 &
echo "âœ… Frontend started - PID: $!"

# 12. VERIFICAR SERVIÃ‡OS
sleep 5
echo "ğŸ“Š SERVICES STATUS:"
ps aux | grep -E "(uvicorn|next)" | grep -v grep

echo ""
echo "ğŸŒ ACESSO:"
echo "Backend:  http://148.230.78.91:8000"
echo "Frontend: http://148.230.78.91:3000"
echo "API Docs: http://148.230.78.91:8000/docs"

echo ""
echo "ğŸ‘¤ LOGIN:"
echo "Email: admin@financas.com"  
echo "Senha: admin123"

echo ""
echo "ğŸ“ LOGS:"
echo "Backend:  tail -f /var/log/financas-backend.log"
echo "Frontend: tail -f /var/log/financas-frontend.log"

# 13. TESTE FINAL
echo ""
echo "ğŸ§ª TESTE FINAL:"
curl -s http://localhost:8000/api/health && echo "âœ… Backend OK"
curl -s http://localhost:3000 | head -5 && echo "âœ… Frontend OK"

echo ""
echo "ğŸ‰ DEPLOY CONCLUÃDO!"