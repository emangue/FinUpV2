{% extends "base.html" %}

{% block title %}Admin - Grupos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-layer-group"></i> Administração de Grupos</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalGrupo">
        <i class="fas fa-plus"></i> Novo Grupo
    </button>
</div>

<div class="alert alert-info">
    <i class="fas fa-info-circle"></i> Gerencie os grupos de transações, suas cores e ícones. Essas configurações serão aplicadas em todas as visualizações.
</div>

<!-- Lista de Grupos -->
<div class="row">
    {% for grupo in grupos %}
    <div class="col-md-6 col-lg-4 mb-3">
        <div class="card" style="border-left: 4px solid {{ grupo.cor }};">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="d-flex align-items-center">
                        <div class="p-3 rounded-circle me-3" style="background-color: {{ grupo.cor }};">
                            <i class="fas {{ grupo.icone }} text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="card-title mb-0">{{ grupo.nome }}</h5>
                            <small class="text-muted">Ordem: {{ grupo.ordem }}</small>
                        </div>
                    </div>
                    <div>
                        {% if grupo.ativo %}
                        <span class="badge bg-success">Ativo</span>
                        {% else %}
                        <span class="badge bg-secondary">Inativo</span>
                        {% endif %}
                    </div>
                </div>
                
                {% if grupo.descricao %}
                <p class="card-text text-muted small">{{ grupo.descricao }}</p>
                {% endif %}
                
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <code class="small">{{ grupo.cor }}</code>
                        <code class="small ms-2">{{ grupo.icone }}</code>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="editarGrupo({{ grupo.to_dict()|tojson }})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletarGrupo({{ grupo.id }}, '{{ grupo.nome }}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    
    {% if not grupos %}
    <div class="col-12">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> Nenhum grupo configurado. Clique em "Novo Grupo" para adicionar.
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Novo/Editar Grupo -->
<div class="modal fade" id="modalGrupo" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-layer-group"></i> <span id="modalTitle">Novo Grupo</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formGrupo" onsubmit="salvarGrupo(event)">
                <div class="modal-body">
                    <input type="hidden" id="grupo_id" name="grupo_id">
                    
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Nome do Grupo *</label>
                            <input type="text" class="form-control" id="grupo_nome" name="nome" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Ordem</label>
                            <input type="number" class="form-control" id="grupo_ordem" name="ordem" value="0">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ícone *</label>
                            <select class="form-select" id="grupo_icone" name="icone" required onchange="previewIcon()">
                                <option value="">Selecione um ícone...</option>
                                {% for icone in icones %}
                                <option value="{{ icone }}">{{ icone }}</option>
                                {% endfor %}
                            </select>
                            <div class="mt-2 text-center">
                                <div id="iconPreview" class="p-3 rounded-circle d-inline-flex" style="background-color: #6c757d;">
                                    <i class="fas fa-tag text-white fs-3"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Cor *</label>
                            <input type="color" class="form-control form-control-color" id="grupo_cor" name="cor" value="#6c757d" required onchange="previewIcon()">
                            <small class="text-muted">Escolha uma cor que represente o grupo</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Descrição</label>
                        <textarea class="form-control" id="grupo_descricao" name="descricao" rows="2"></textarea>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="grupo_ativo" name="ativo" value="true" checked>
                        <label class="form-check-label" for="grupo_ativo">
                            Grupo ativo
                        </label>
                    </div>
                    
                    <div id="mensagemModal"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function previewIcon() {
    const icone = document.getElementById('grupo_icone').value;
    const cor = document.getElementById('grupo_cor').value;
    const preview = document.getElementById('iconPreview');
    
    preview.style.backgroundColor = cor;
    preview.innerHTML = `<i class="fas ${icone} text-white fs-3"></i>`;
}

function editarGrupo(grupo) {
    document.getElementById('modalTitle').textContent = 'Editar Grupo';
    document.getElementById('grupo_id').value = grupo.id;
    document.getElementById('grupo_nome').value = grupo.nome;
    document.getElementById('grupo_icone').value = grupo.icone;
    document.getElementById('grupo_cor').value = grupo.cor;
    document.getElementById('grupo_descricao').value = grupo.descricao || '';
    document.getElementById('grupo_ordem').value = grupo.ordem;
    document.getElementById('grupo_ativo').checked = grupo.ativo;
    
    previewIcon();
    
    new bootstrap.Modal(document.getElementById('modalGrupo')).show();
}

function salvarGrupo(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    
    fetch('/admin/grupos/salvar', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            document.getElementById('mensagemModal').innerHTML = 
                `<div class="alert alert-danger mt-3">${data.error}</div>`;
        }
    })
    .catch(error => {
        document.getElementById('mensagemModal').innerHTML = 
            `<div class="alert alert-danger mt-3">Erro ao salvar: ${error}</div>`;
    });
}

function deletarGrupo(id, nome) {
    if (!confirm(`Tem certeza que deseja deletar o grupo "${nome}"?`)) {
        return;
    }
    
    fetch(`/admin/grupos/deletar/${id}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erro ao deletar: ' + data.error);
        }
    })
    .catch(error => {
        alert('Erro ao deletar: ' + error);
    });
}

// Limpar formulário ao abrir modal
document.getElementById('modalGrupo').addEventListener('show.bs.modal', function (event) {
    if (!event.relatedTarget) {
        document.getElementById('modalTitle').textContent = 'Novo Grupo';
        document.getElementById('formGrupo').reset();
        document.getElementById('grupo_id').value = '';
        previewIcon();
    }
});
</script>
{% endblock %}
