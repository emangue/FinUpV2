{% extends "base.html" %}

{% block title %}Dashboard - Transa√ß√µes Processadas{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="fas fa-chart-bar"></i> Dashboard de Transa√ß√µes</h2>

<!-- Resumo Geral -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h6 class="card-title">Total de Transa√ß√µes</h6>
                <h2 class="mb-0">{{ total_transacoes }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <h6 class="card-title">Precisam Valida√ß√£o</h6>
                <h2 class="mb-0">{{ precisam_validacao }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-info">
            <div class="card-body">
                <h6 class="card-title">Duplicados Removidos</h6>
                <h2 class="mb-0">
                    {{ duplicados_count }}
                    {% if duplicados_count > 0 %}
                        <a href="{{ url_for('duplicados') }}" class="btn btn-sm btn-light float-end">Ver</a>
                    {% endif %}
                </h2>
            </div>
        </div>
    </div>
</div>

<!-- Detalhes por Origem -->
<h4 class="mb-3">Detalhes por Origem</h4>

<form method="POST" action="{{ url_for('salvar') }}">
    {% for origem in origens %}
        {% set stats = stats_por_origem[origem] %}
        <div class="card mb-3">
            <div class="card-header d-flex align-items-center">
                <input type="checkbox" class="form-check-input me-2 origem-checkbox" name="origens_selecionadas" value="{{ origem }}" id="origem_{{ loop.index }}">
                <label class="form-check-label flex-grow-1" for="origem_{{ loop.index }}">
                    <strong>{{ origem }}</strong> ({{ stats.quantidade }} transa√ß√µes)
                </label>
            </div>
            <div class="card-body">
                {% if stats.tipo == 'fatura' %}
                    <!-- Fatura -->
                    <h5 class="text-primary">üí≥ Valor Total: R$ {{ "%.2f"|format(stats.total) }}</h5>
                    <h6 class="mt-3">Breakdown por Tipo de Gasto:</h6>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Tipo de Gasto</th>
                                <th class="text-end">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tipo, valor in stats.breakdown.items() %}
                            <tr>
                                <td>{{ tipo }}</td>
                                <td class="text-end">R$ {{ "%.2f"|format(valor) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <!-- Extrato -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <h6>Despesas</h6>
                                <h4 class="text-danger">R$ {{ "%.2f"|format(stats.despesas) }}</h4>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h6>Receitas</h6>
                                <h4 class="text-success">R$ {{ "%.2f"|format(stats.receitas) }}</h4>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h6>Saldo</h6>
                                <h4 class="{% if stats.saldo >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    R$ {{ "%.2f"|format(stats.saldo) }}
                                </h4>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endfor %}

    <!-- A√ß√µes -->
    <div class="card">
        <div class="card-body">
            <div class="form-check mb-3">
                <input type="checkbox" class="form-check-input" id="select_all">
                <label class="form-check-label" for="select_all">
                    <strong>Selecionar Todas as Origens</strong>
                </label>
            </div>

            <div class="d-grid gap-2">
                <div class="d-flex justify-content-between gap-2 mb-2">
                    {% if precisam_validacao > 0 %}
                    <a href="{{ url_for('validar') }}" class="btn btn-warning flex-fill">
                        <i class="fas fa-exclamation-triangle"></i> Validar {{ precisam_validacao }} Pendentes
                    </a>
                    {% endif %}
                    
                    <a href="{{ url_for('validar') }}?tipo=todas" class="btn btn-info flex-fill">
                        <i class="fas fa-list"></i> Ver Todas as Transa√ß√µes
                    </a>
                </div>
                
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="fas fa-save"></i> Salvar Selecionadas na Journal Entries
                </button>
            </div>
        </div>
    </div>
</form>

<div class="mt-3">
    <a href="{{ url_for('upload') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Voltar ao Upload
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
// Checkbox "Selecionar Todas"
document.getElementById('select_all').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.origem-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
});

// Atualiza "Selecionar Todas" se todas estiverem marcadas
document.querySelectorAll('.origem-checkbox').forEach(cb => {
    cb.addEventListener('change', function() {
        const all = document.querySelectorAll('.origem-checkbox');
        const checked = document.querySelectorAll('.origem-checkbox:checked');
        document.getElementById('select_all').checked = all.length === checked.length;
    });
});
</script>
{% endblock %}
