{% extends "base.html" %}

{% block title %}Dashboard - Gestor Financeiro{% endblock %}

{% block extra_css %}
<style>
.metric-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.metric-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.metric-value {
    font-size: 2rem;
    font-weight: 700;
    margin: 8px 0;
}

.metric-label {
    color: #6c757d;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.metric-change {
    font-size: 0.875rem;
    font-weight: 600;
    margin-top: 4px;
}

.metric-change.positive { color: #28a745; }
.metric-change.negative { color: #dc3545; }

.chart-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    height: 100%;
}

.chart-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 16px;
    color: #2c3e50;
}

.top-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    background: #f8f9fa;
}

.top-item:hover { background: #e9ecef; }

.top-item-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    flex-shrink: 0;
}

.top-item-icon img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
}

.top-item-name { flex: 1; font-weight: 500; }
.top-item-value { font-weight: 600; margin-right: 8px; }

.top-item-bar {
    width: 60px;
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
}

.top-item-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    border-radius: 3px;
}

.alert-card {
    border-left: 4px solid;
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 12px;
    background: white;
}

.alert-card.warning { border-color: #ffc107; background: #fff8e1; }
.alert-card.success { border-color: #28a745; background: #d4edda; }
.alert-card.info { border-color: #17a2b8; background: #d1ecf1; }

.btn-add-data {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    padding: 16px 32px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1.1rem;
    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
    transition: all 0.3s;
}

.btn-add-data:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    color: white;
}

.dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 32px;
    border-radius: 16px;
    margin-bottom: 32px;
}
</style>
{% endblock %}

{% block content %}
<!-- Header do Dashboard -->
<div class="dashboard-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <h1 class="mb-2">Dashboard Financeiro</h1>
            <p class="mb-0 opacity-75">Vis√£o geral das suas finan√ßas</p>
        </div>
        
        <div class="d-flex gap-3 align-items-center mt-3 mt-md-0">
            <form class="d-flex gap-2 align-items-center bg-white p-2 rounded shadow-sm" action="{{ url_for('dashboard.index') }}" method="get">
                <label for="mes" class="text-dark mb-0 fw-bold small"><i class="fas fa-calendar-alt me-2"></i>M√™s:</label>
                <input type="month" id="mes" name="mes" class="form-control form-control-sm border-0 bg-light" 
                       value="{{ mes_atual }}" 
                       onchange="this.form.submit()"
                       style="width: auto;">
            </form>
            
            <a href="/upload" class="btn btn-light text-primary fw-bold shadow-sm">
                <i class="fas fa-plus-circle me-2"></i>
                Adicionar
            </a>
        </div>
    </div>
</div>

<!-- Cards de M√©tricas Principais -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card">
            <div class="metric-label">Total Despesas</div>
            <div class="metric-value text-danger">R$ {{ stats.total_despesas|abs|format_currency }}</div>
            <div class="metric-change {% if stats.variacao_despesas < 0 %}positive{% else %}negative{% endif %}">
                <i class="fas fa-arrow-{% if stats.variacao_despesas < 0 %}down{% else %}up{% endif %}"></i>
                {{ "%.1f"|format(stats.variacao_despesas|abs) }}% vs m√™s anterior
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card">
            <div class="metric-label">Total Receitas</div>
            <div class="metric-value text-success">R$ {{ stats.total_receitas|format_currency }}</div>
            <div class="metric-change {% if stats.variacao_receitas > 0 %}positive{% else %}negative{% endif %}">
                <i class="fas fa-arrow-{% if stats.variacao_receitas > 0 %}up{% else %}down{% endif %}"></i>
                {{ "%.1f"|format(stats.variacao_receitas|abs) }}% vs m√™s anterior
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card">
            <div class="metric-label">Saldo Atual</div>
            <div class="metric-value {% if stats.saldo >= 0 %}text-success{% else %}text-danger{% endif %}">
                R$ {{ stats.saldo|format_currency }}
            </div>
            <div class="metric-change {% if stats.variacao_saldo >= 0 %}positive{% else %}negative{% endif %}">
                <i class="fas fa-arrow-{% if stats.variacao_saldo >= 0 %}up{% else %}down{% endif %}"></i>
                {{ "%.1f"|format(stats.variacao_saldo|abs) }}% vs m√™s anterior
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card">
            <div class="metric-label">Transa√ß√µes</div>
            <div class="metric-value text-primary">{{ stats.total_transacoes }}</div>
            <div class="metric-change info">
                <i class="fas fa-check-circle"></i>
                {{ stats.perc_classificadas }}% classificadas
            </div>
        </div>
    </div>
</div>

<!-- Gr√°ficos e An√°lises -->
<div class="row mb-4">
    <!-- Evolu√ß√£o Mensal -->
    <div class="col-lg-8 mb-4">
        <div class="chart-card">
            <h5 class="chart-title">Evolu√ß√£o Mensal - Receitas vs Despesas (√öltimos 6 Meses)</h5>
            <canvas id="chartEvolucao" height="200"></canvas>
        </div>
    </div>
    
    <!-- Distribui√ß√£o por Grupo -->
    <div class="col-lg-4 mb-4">
        <div class="chart-card">
            <h5 class="chart-title">Despesas por Categoria</h5>
            <div style="height: 200px; display: flex; align-items: center; justify-content: center; color: #6c757d;">
                <i class="fas fa-chart-pie fa-3x opacity-25"></i>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Top 10 SubGrupos -->
    <div class="col-lg-8 mb-4">
        <div class="chart-card">
            <h5 class="chart-title">Top 10 SubGrupos</h5>
            <div id="topEstabelecimentos">
                {% for item in top_estabelecimentos %}
                <div class="top-item" style="cursor: pointer;" onclick="abrirDetalhesSubgrupo('{{ item.estabelecimento }}')">
                    <div class="top-item-icon" style="background-color: {{ item.grupo|get_group_color }};">
                        <i class="fas {{ item.grupo|get_group_icon }} text-white"></i>
                    </div>
                    <div class="top-item-name">{{ item.estabelecimento }}</div>
                    <div class="top-item-value text-danger">R$ {{ item.total|abs|format_currency }}</div>
                    <div class="top-item-bar">
                        <div class="top-item-bar-fill" style="width: {{ item.percentual }}%;"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Insights e Alertas com Gr√°fico -->
    <div class="col-lg-4 mb-4">
        <div class="chart-card">
            <h5 class="chart-title">Insights e Alertas</h5>
            
            <!-- Insights -->
            <div class="mb-3">
                {% if stats.perc_classificadas < 70 %}
                <div class="alert-card warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>{{ (100 - stats.perc_classificadas)|int }}%</strong> das transa√ß√µes ainda n√£o classificadas
                </div>
                {% endif %}
                
                {% if stats.maior_aumento %}
                <div class="alert-card warning">
                    <i class="fas fa-arrow-up me-2"></i>
                    <strong>{{ stats.maior_aumento.grupo }}</strong> aumentou {{ "%.0f"|format(stats.maior_aumento.variacao) }}% este m√™s
                </div>
                {% endif %}
                
                {% if stats.maior_economia %}
                <div class="alert-card success">
                    <i class="fas fa-arrow-down me-2"></i>
                    <strong>{{ stats.maior_economia.grupo }}</strong> reduziu {{ "%.0f"|format(stats.maior_economia.variacao|abs) }}%
                </div>
                {% endif %}
                
                <div class="alert-card info">
                    <i class="fas fa-calendar-alt me-2"></i>
                    M√©dia di√°ria: <strong>R$ {{ stats.media_diaria|abs|format_currency }}</strong>
                </div>
                
                <div class="alert-card info">
                    <i class="fas fa-store me-2"></i>
                    <strong>{{ stats.total_estabelecimentos }}</strong> estabelecimentos diferentes
                </div>
            </div>
            
            <!-- Gr√°fico de Pizza por Tipo de Gasto -->
            <div style="height: 250px; display: flex; flex-direction: column; margin-bottom: -24px;">
                <div style="flex-grow: 1;"></div>
                <div class="d-flex justify-content-center align-items-center mb-2">
                    <h6 class="mb-0 me-2">Distribui√ß√£o por Tipo</h6>
                    <button class="btn btn-sm btn-outline-secondary" onclick="abrirEditorCores()" title="Editar cores dos grupos">
                        <i class="fas fa-palette"></i> Editar
                    </button>
                </div>
                <canvas id="chartTipos" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editor de Cores -->
<div class="modal fade" id="modalEditorCores" tabindex="-1" aria-labelledby="modalEditorCoresLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditorCoresLabel">
                    <i class="fas fa-palette"></i> Editor de Cores dos Grupos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">
                    <i class="fas fa-info-circle"></i> As altera√ß√µes ser√£o aplicadas em todos os gr√°ficos e visualiza√ß√µes do sistema.
                </p>
                <div id="listaGruposCores" class="row g-3">
                    <!-- Ser√° preenchido via JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="salvarCores()">
                    <i class="fas fa-save"></i> Salvar Cores
                </button>
            </div>
        </div>
    </div>
</div>

<!-- √öltimas Transa√ß√µes -->
<div class="row">
    <div class="col-12">
        <div class="chart-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="chart-title mb-0">√öltimas Transa√ß√µes</h5>
                <a href="{{ url_for('dashboard.transacoes', mes=mes_atual) }}" class="btn btn-sm btn-outline-primary">
                    Ver Todas <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Estabelecimento</th>
                            <th>Categoria</th>
                            <th class="text-end">Valor</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trans in ultimas_transacoes %}
                        <tr style="cursor: pointer;" onclick="abrirDetalhesTransacao('{{ trans.ID }}')">
                            <td>
                                {% if trans.Data %}
                                    {% if trans.Data is string %}
                                        {{ trans.Data }}
                                    {% else %}
                                        {{ trans.Data.strftime('%d/%m/%Y') }}
                                    {% endif %}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                {% set logo_path = trans.Estabelecimento|get_estabelecimento_logo %}
                                {% if logo_path %}
                                    <img src="{{ logo_path }}" alt="{{ trans.Estabelecimento }}" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover; margin-right: 8px;">
                                {% endif %}
                                {{ trans.Estabelecimento }}
                            </td>
                            <td>
                                {% if trans.GRUPO %}
                                    <span class="badge" style="background-color: {{ trans.GRUPO|get_group_color }};">
                                        <i class="fas {{ trans.GRUPO|get_group_icon }}"></i> {{ trans.GRUPO }}
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">Sem classifica√ß√£o</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <span class="{% if trans.Valor < 0 %}text-danger{% else %}text-success{% endif %} fw-bold">
                                    R$ {{ trans.Valor|format_currency }}
                                </span>
                            </td>
                            <td>
                                {% if trans.GRUPO %}
                                    <span class="badge bg-success">Classificado</span>
                                {% else %}
                                    <span class="badge bg-warning">Pendente</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Detalhes da Transa√ß√£o -->
<div class="modal fade" id="modalDetalhesTransacao" tabindex="-1" aria-labelledby="modalDetalhesLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetalhesLabel">
                    <i class="fas fa-receipt"></i> Detalhes da Transa√ß√£o
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="conteudoDetalhes">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Carregar Chart.js PRIMEIRO, antes de qualquer outra biblioteca -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Fun√ß√µes globais para modais
function abrirDetalhesTransacao(transacaoId) {
    const modal = new bootstrap.Modal(document.getElementById('modalDetalhesTransacao'));
    const conteudo = document.getElementById('conteudoDetalhes');
    
    // Reset do conte√∫do
    conteudo.innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></div>';
    
    modal.show();
    
    // Buscar detalhes via API
    fetch(`/api/transacao/${transacaoId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                conteudo.innerHTML = '<div class="alert alert-danger">Erro: ' + data.error + '</div>';
                return;
            }
            
            const valorClass = data.Valor < 0 ? 'text-danger' : 'text-success';
            const tipoTransacao = data.Valor < 0 ? 'Despesa' : 'Receita';
            
            conteudo.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold mb-3"><i class="fas fa-info-circle text-primary"></i> Informa√ß√µes B√°sicas</h6>
                        <table class="table table-sm">
                            <tr><td class="fw-bold">ID:</td><td>${data.ID}</td></tr>
                            <tr><td class="fw-bold">Data:</td><td>${data.Data}</td></tr>
                            <tr><td class="fw-bold">Estabelecimento:</td><td>${data.Estabelecimento || 'N/A'}</td></tr>
                            <tr><td class="fw-bold">Valor:</td><td class="${valorClass} fw-bold">R$ ${Math.abs(data.Valor).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td></tr>
                            <tr><td class="fw-bold">Tipo:</td><td><span class="badge ${data.Valor < 0 ? 'bg-danger' : 'bg-success'}">${tipoTransacao}</span></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold mb-3"><i class="fas fa-tags text-success"></i> Classifica√ß√£o</h6>
                        <table class="table table-sm">
                            <tr><td class="fw-bold">Grupo:</td><td>${data.GRUPO || '<span class="text-muted">N√£o classificado</span>'}</td></tr>
                            <tr><td class="fw-bold">SubGrupo:</td><td>${data.SubGrupo || '<span class="text-muted">N/A</span>'}</td></tr>
                            <tr><td class="fw-bold">Categoria:</td><td>${data.CategoriaTransacao || '<span class="text-muted">N/A</span>'}</td></tr>
                            <tr><td class="fw-bold">Status:</td><td>${data.StatusTransacao || '<span class="text-muted">N/A</span>'}</td></tr>
                            <tr><td class="fw-bold">No Dashboard:</td><td>${data.IgnorarDashboard ? '<span class="badge bg-secondary">N√£o</span>' : '<span class="badge bg-primary">Sim</span>'}</td></tr>
                        </table>
                    </div>
                </div>
                ${data.Descricao ? `
                <div class="mt-3">
                    <h6 class="fw-bold"><i class="fas fa-align-left text-info"></i> Descri√ß√£o</h6>
                    <div class="alert alert-light">${data.Descricao}</div>
                </div>` : ''}
                ${data.PixChaveDestino ? `
                <div class="mt-3">
                    <h6 class="fw-bold"><i class="fab fa-pix text-warning"></i> PIX</h6>
                    <div class="alert alert-warning">Chave Destino: ${data.PixChaveDestino}</div>
                </div>` : ''}
            `;
        })
        .catch(error => {
            conteudo.innerHTML = '<div class="alert alert-danger">Erro ao carregar detalhes: ' + error.message + '</div>';
        });
}

function abrirDetalhesSubgrupo(subgrupo) {
    // Por enquanto, s√≥ mostra um alerta
    Swal.fire({
        title: 'Detalhes do SubGrupo',
        text: `Voc√™ clicou no subgrupo: ${subgrupo}`,
        icon: 'info',
        confirmButtonText: 'OK'
    });
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('üìä Dashboard principal - Iniciando gr√°ficos...');
    
    // Aguardar um momento para garantir que tudo carregou
    setTimeout(function() {
        // Helper para formatar moeda
        const formatCurrency = (value) => value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        
        // Helper para converter valores em milhares
        const formatThousands = (value) => {
            const thousands = Math.abs(value) / 1000;
            return thousands.toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
        };

        // Debug: Verificar dados
        console.log('=== DEBUG DASHBOARD PRINCIPAL ===');
        console.log('Chart.js dispon√≠vel:', typeof Chart !== 'undefined');
        console.log('Grupos Labels:', {{ grupos_labels|tojson }});
        console.log('Grupos Valores:', {{ grupos_valores|tojson }});
        console.log('Evolu√ß√£o Meses:', {{ evolucao_meses|tojson }});

        try {
            // üìä Gr√°fico de Barras - Evolu√ß√£o Mensal
            const ctxEvolucao = document.getElementById('chartEvolucao');
            if (ctxEvolucao && typeof Chart !== 'undefined') {
                console.log('üìä Criando gr√°fico de barras...');
                new Chart(ctxEvolucao.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: {{ evolucao_meses|tojson }},
                        datasets: [{
                            label: 'Receitas',
                            data: {{ evolucao_receitas|tojson }},
                            backgroundColor: 'rgba(40, 167, 69, 0.8)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 1,
                            borderRadius: 6,
                            borderSkipped: false
                        }, {
                            label: 'Despesas',
                            data: {{ evolucao_despesas|tojson }},
                            backgroundColor: 'rgba(220, 53, 69, 0.8)',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            borderWidth: 1,
                            borderRadius: 6,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: { intersect: false, mode: 'index' },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { 
                                    padding: 15, 
                                    usePointStyle: true,
                                    font: { size: 12, weight: '500' }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        let value = Math.abs(context.parsed.y);
                                        return label + ': R$ ' + formatCurrency(value);
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { font: { size: 11 } }
                            },
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0,0,0,0.1)' },
                                ticks: {
                                    callback: function(value) {
                                        return formatThousands(value) + 'k';
                                    },
                                    font: { size: 10 }
                                }
                            }
                        },
                        elements: {
                            bar: {
                                borderRadius: {
                                    topLeft: 6,
                                    topRight: 6,
                                    bottomLeft: 6,
                                    bottomRight: 6
                                }
                            }
                        },
                        animation: {
                            onComplete: function() {
                                const chart = this;
                                const ctx = chart.ctx;
                                ctx.font = '11px Arial';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'bottom';
                                
                                chart.data.datasets.forEach((dataset, i) => {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((bar, index) => {
                                        const data = dataset.data[index];
                                        const value = formatThousands(data);
                                        ctx.fillStyle = dataset.backgroundColor;
                                        ctx.fillText(value + 'k', bar.x, bar.y - 5);
                                    });
                                });
                            }
                        }
                    }
                });
                console.log('‚úÖ Gr√°fico de barras criado com sucesso!');
            } else {
                console.error('‚ùå Elemento chartEvolucao n√£o encontrado ou Chart.js n√£o dispon√≠vel');
            }

            // üç∞ Gr√°fico de Pizza - Tipos de Gasto (no box de insights)
            const ctxTipos = document.getElementById('chartTipos');
            if (ctxTipos && typeof Chart !== 'undefined') {
                console.log('üç∞ Criando gr√°fico de pizza para tipos...');
                new Chart(ctxTipos.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: {{ grupos_labels|tojson }},
                        datasets: [{
                            data: {{ grupos_valores|tojson }},
                            backgroundColor: {{ grupos_cores|tojson }},
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { 
                                    padding: 10, 
                                    font: { size: 10 },
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        let value = Math.abs(context.parsed);
                                        let total = context.dataset.data.reduce((a, b) => Math.abs(a) + Math.abs(b), 0);
                                        let percentage = ((Math.abs(context.parsed) / total) * 100).toFixed(1);
                                        return label + ': ' + percentage + '% (R$ ' + formatCurrency(value) + ')';
                                    }
                                }
                            }
                        },
                        animation: {
                            onComplete: function() {
                                const chart = this;
                                const ctx = chart.ctx;
                                
                                chart.data.datasets.forEach((dataset, i) => {
                                    const meta = chart.getDatasetMeta(i);
                                    const total = dataset.data.reduce((a, b) => Math.abs(a) + Math.abs(b), 0);
                                    
                                    meta.data.forEach((segment, index) => {
                                        const value = Math.abs(dataset.data[index]);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        
                                        if (percentage >= 5) { // S√≥ mostra % se for >= 5%
                                            const angle = segment.startAngle + (segment.endAngle - segment.startAngle) / 2;
                                            const x = segment.x + Math.cos(angle) * (segment.outerRadius * 0.7);
                                            const y = segment.y + Math.sin(angle) * (segment.outerRadius * 0.7);
                                            
                                            ctx.fillStyle = 'white';
                                            ctx.font = 'bold 11px Arial';
                                            ctx.textAlign = 'center';
                                            ctx.textBaseline = 'middle';
                                            ctx.fillText(percentage + '%', x, y);
                                        }
                                    });
                                });
                            }
                        }
                    }
                });
                console.log('‚úÖ Gr√°fico de pizza de tipos criado com sucesso!');
            } else {
                console.error('‚ùå Elemento chartTipos n√£o encontrado');
            }
            
        } catch (error) {
            console.error('‚ùå Erro na cria√ß√£o dos gr√°ficos:', error);
        }
    }, 100); // Aguardar 100ms para garantir que tudo carregou
});
</script>
{% endblock %}
