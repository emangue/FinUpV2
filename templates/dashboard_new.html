{% extends "base.html" %}

{% block title %}Dashboard - Gestor Financeiro{% endblock %}

{% block extra_css %}
<style>
.metric-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.metric-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.metric-value {
    font-size: 2rem;
    font-weight: 700;
    margin: 8px 0;
}

.metric-label {
    color: #6c757d;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.metric-change {
    font-size: 0.875rem;
    font-weight: 600;
    margin-top: 4px;
}

.metric-change.positive {
    color: #28a745;
}

.metric-change.negative {
    color: #dc3545;
}

.chart-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    height: 100%;
}

.chart-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 16px;
    color: #2c3e50;
}

.top-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    background: #f8f9fa;
}

.top-item:hover {
    background: #e9ecef;
}

.top-item-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    flex-shrink: 0;
}

.top-item-icon img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
}

.top-item-name {
    flex: 1;
    font-weight: 500;
}

.}

.metric-change {
    f-weight: 600;
    margin-right: 8px;
}

.top-item-bar {
    width: 60px;
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
}

.top-item-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    border-radius: 3px;
}

.alert-card {
    border-left: 4px solid;
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 12px;
    background: white;
}

.alert-card.warning {
    border-color: #ffc107;
    background: #fff8e1;
}

.alert-card.success {
    border-color: #28a745;
    background: #d4edda;
}

.ale    background:    border-color: #17a2b8;
    background: #d1ecf1;
}

.btn-add-data {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    padding: 16px 32px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1.1rem;
    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
    transition: all 0.3s;
}

.btn-add-data:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    color: white;
}

.dashboard-header {
    b    border-radius: 3px;ent(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 32px;
    border-radius: 16px;
    margin-bottom: 32px;
}
</style>
{% endblock %}

{% block content %}
<!-- Header do Dashboard -->
<div class="dashboard-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="mb-2">Dashboard Financeiro</h1>
            <p class="mb-0 opacity-75">Visão geral das suas finanças</p>
        </div>
        <a href="/" class="btn btn-add-data">
            <i class="fas fa-plus-circle me-2"></i>
            Adicionar Novos Dados
        </a>
    </div>
</div>

<!-- Cards de Métricas Principais -->
<div class="row mb-4">
    <div     font-weight: 600;
      <div class="metric-card">
            <div class="metric-label">Total Despesas</div>
            <div class="metric-value text-danger">R$ {{ "%.2f"|format(stats.total_despesas|abs) }}</div>
            <div class="metric-change {% if stats.variacao_despesas < 0 %}positive{% else %}negative{% endif %}">
                <i class="fas fa-arrow-{% if stats.variacao_despesas < 0 %}down{% else %}up{% endif %}"></i>
                {{ "%.1f"|format(stats.variacao_despesas|abs) }}% vs mês anterior
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="metric-card">
            <div class="metric-label">Total Receitas</div>
            <div class="metric-value text-success">R$ {{ "%.2f"|format(stats.total_receita            <i class="fasiv class="metric-change {% if stats.variacao_receitas > 0 %}positive{% else %}negative{% endif %}">
                <i class="fas fa-arrow-{% if stats.variacao_receitas > 0 %}up{% else %}down{% endif %}"></i>
                {{ "%.1f"|format(stats.variacao_receitas|abs) }}% vs mês anterior
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="metric-card">
            <div class="metric-label">Saldo Atual</div>
            <div class="metric-value {% if stats.saldo >= 0 %}text-success{% else %}text-danger{% endif %}">
                R$ {{ "%.2f"|format(stats.saldo) }}
            </div>
            <div class="metric-change {% if stats.variacao_saldo >= 0 %}positive{% else %}negative{% endif %}">
                <i class="fas fa-arrow-{% if stats.variacao_            <div class="metric-lndif %}"></i>
                {{ "%.1f"|format(stats.variacao_saldo|abs) }}% vs mês anterior
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="metric-card">
            <div class="metric-label">Transações</div>
            <div class="metric-value text-primary">{{ stats.total_transacoes }}</div>
            <div class="metric-change info">
                <i class="fas fa-check-circle"></i>
                {{ stats.perc_classificadas }}% classificadas
            </div>
        </div>
    </div>
</div>

<!-- Gráficos e Análises -->
<div class="row mb-4">
    <!-- Distribuição por Grupo -->
    <div class="col-lg-4 mb-4">
        <div class="chart-card">
            <h5 class="chart-title">Despesas por Categoria</h5>
            <canvas id="chartGrupo                <i class="fas fa-arrow-{% if stats.variacao_            <div class="metric-lndif %}"></i>
    
        <div class="chart-card">
            <h5 class="chart-title">Evolução Mensal (Últimos 6 Meses)</h5>
            <canvas id="chartEvolucao" height="250"></canvas>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Top 10 Estabelecimentos -->
    <div class="col-lg-8 mb-4">
        <div class="chart-card">
            <h5 class="chart-title">Top 10 Estabelecimentos</h5>
            <div id="topEstabelecimentos">
                {% for item in top_estabelecimentos %}
                <div class="top-item">
                    {% set logo_path = item.estabelecimento|get_estabelecimento_logo %}
                    <div class="top-item-icon" style="background-color: {{ item.grupo|get_group_color }};">
                        {% if logo_path %}
                            <img src="{{ l            <canvas id="chartGrupo                <i class="fa      {% else %}
                            <i class="fas {{ item.grupo|get_group_icon }} text-white"></i>
                        {% endif %}
                    </div>
                    <div class="top-item-name">{{ item.estabelecimento }}</div>
                    <div class="top-item-value text-danger">R$ {{ "%.2f"|format(item.total|abs) }}</div>
                    <div class="top-item-bar">
                        <div class="top-item-bar-fill" style="width: {{ item.percentual }}%;"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Alertas e Insights -->
    <div class="col-lg-4 mb-4">
        <div class="chart-card">
            <h5 class="chart-title">Insights e Alertas</h5>
            
            {% if stats.perc_classificadas < 70 %}
            <div class="alert-card warning">
                <i cl                            <i class="fas {{ item.grupo|get_group_icon }} text-whit.perc_classificadas)|int }}%</strong> das transações ainda não classificadas
            </div>
            {% endif %}
            
            {% if stats.maior_aumento %}
            <div class="alert-card warning">
                <i class="fas fa-arrow-up me-2"></i>
                <strong>{{ stats.maior_aumento.grupo }}</strong> aumentou {{ "%.0f"|format(stats.maior_aumento.variacao) }}% este mês
            </div>
            {% endif %}
            
            {% if stats.maior_economia %}
            <div class="alert-card success">
                <i class="fas fa-arrow-down me-2"></i>
                <strong>{{ stats.maior_economia.grupo }}</strong> reduziu {{ "%.0f"|format(stats.maior_economia.variacao|abs) }}%
            </div>
            {% endif %}
            
            <div class="alert-card info">
                <i class="fas fa-calendar-alt me-2"></i>
                Média diá            </div>
            {% endif %}
            
            {% if stats.maior_au      
            <div class="alert-card info">
                <i class="fas fa-store me-2"></i>
                <strong>{{ stats.total_estabelecimentos }}</strong> estabelecimentos diferentes
            </div>
        </div>
    </div>
</div>

<!-- Últimas Transações -->
<div class="row">
    <div class="col-12">
        <div class="chart-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="chart-title mb-0">Últimas Transações</h5>
                <a href="/validar" class="btn btn-sm btn-outline-primary">
                    Ver Todas <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover">
                           <i class="fas fa-calenda                            <th>Data</th>
                            <th>Estabelecimento</th>
                            <th>Categoria</th>
                            <th class="text-end">Valor</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trans in ultimas_transacoes %}
                        <tr>
                            <td>{{ trans.Data.strftime('%d/%m/%Y') if trans.Data else 'N/A' }}</td>
                            <td>
                                {% set logo_path = trans.Estabelecimento|get_estabelecimento_logo %}
                                {% if logo_path %}
                                    <img src="{{ logo_path }}" alt="{{ trans.Estabelecimento }}" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover; margin-right: 8px;">
                                                  <i class="fas fa-cale     {{ trans.Estabelecimento }}
                            </td>
                            <td>
                                {% if trans.GRUPO %}
                                    <span class="badge" style="background-color: {{ trans.GRUPO|get_group_color }};">
                                        <i class="fas {{ trans.GRUPO|get_group_icon }}"></i> {{ trans.GRUPO }}
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">Sem classificação</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <span class="{% if trans.Valor < 0 %}text-danger{% else %}text-success{% endif %} fw-bold">
                                    R$ {{ "%.2f"|format(trans.Valor) }}
                                </span>
                                                    </td>
                                       {% if trans.GRUPO %}
                                    <span class="badge bg-success">Classificado</span>
                                {% else %}
                                    <span class="badge bg-warning">Pendente</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Gráfico de Pizza - Distribuição por Grupo
const ctxGrupos = document.getElementById('chartGrupos').getContext('2d');
new Chart(ctxGrupos, {
    type: 'doughnut',
    data: {
        labels: {{ grupos_labels|tojson }},
        datasets: [{
            data: {{ grupos_valores|tojson }},
            b                                       {% if trans.GRUPOerWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 15,
                    font: {
                        size: 11
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.label || '';
                        let value = Math.abs(context.parsed);
                        let total = context.dataset.data.reduce((a, b) => Math.abs(a) + Math.abs(b), 0);
                        let percentage = ((Math.abs(context.parsed) / total) * 100).toFixed(1);
                        return label + ': R$ ' + value.toFixed(2) + ' (' + percentage + '%)';
                 b                                  }
        }
    }
});

// Gráfico de Linha - Evolução Mensal
const ctxEvolucao = document.getElementById('chartEvolucao').getContext('2d');
new Chart(ctxEvolucao, {
    type: 'line',
    data: {
        labels: {{ evolucao_meses|tojson }},
        datasets: [{
            label: 'Despesas',
            data: {{ evolucao_despesas|tojson }},
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
        }, {
            label: 'Receitas',
            data: {{ evolucao_receitas|tojson }},
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        i                 b                                  }
        }
    }      },
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    padding: 15,
                    usePointStyle: true
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        let value = Math.abs(context.parsed.y);
                        return label + ': R$ ' + value.toFixed(2);
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'R$ ' + Math.abs(value).toFixed(0);
                    }
                }
            }
        }
       },
  script>
{% endblock %}
