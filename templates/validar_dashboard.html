{% extends "validar.html" %}

{% block extra_css %}
{{ super() }}
<style>
.chart-container {
    position: relative;
    height: 300px;
    margin-bottom: 2rem;
}

.stats-card {
    border-left: 4px solid;
    transition: transform 0.2s;
}

.stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
</style>
{% endblock %}

{% block content %}
{{ super() }}

<!-- Dashboard de Estatísticas -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Visão Geral das Transações</h5>
            </div>
            <div class="card-body">
                <!-- Cards de Estatísticas -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stats-card border-success">
                            <div class="card-body">
                                <h6 class="text-muted">Total de Transações</h6>
                                <h3 class="mb-0"><i class="fas fa-receipt"></i> {{ total }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card border-danger">
                            <div class="card-body">
                                <h6 class="text-muted">Valor Total</h6>
                                <h3 class="mb-0 text-danger">
                                    <i class="fas fa-dollar-sign"></i>
                                    <span id="totalValue">R$ 0,00</span>
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card border-warning">
                            <div class="card-body">
                                <h6 class="text-muted">Categorias Únicas</h6>
                                <h3 class="mb-0 text-warning">
                                    <i class="fas fa-tags"></i>
                                    <span id="uniqueCategories">0</span>
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card border-info">
                            <div class="card-body">
                                <h6 class="text-muted">Média por Transação</h6>
                                <h3 class="mb-0 text-info">
                                    <i class="fas fa-calculator"></i>
                                    <span id="avgValue">R$ 0,00</span>
                                </h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="row">
                    <div class="col-md-6">
                        <h6>Distribuição por Grupo</h6>
                        <div class="chart-container">
                            <canvas id="chartByGroup"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Distribuição por Classificação</h6>
                        <div class="chart-container">
                            <canvas id="chartByClassification"></canvas>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <h6>Top 10 Maiores Valores</h6>
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="chartTopValues"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Dados das transações para gráficos
const transactions = {{ transacoes_todas|tojson }};

// Calcula estatísticas
let totalValue = 0;
let grupos = {};
let classificacoes = {};
let valores = [];

transactions.forEach(([idx, trans]) => {
    const valor = parseFloat(trans.Valor || 0);
    totalValue += Math.abs(valor);
    
    const grupo = trans.GRUPO || 'Sem Grupo';
    grupos[grupo] = (grupos[grupo] || 0) + Math.abs(valor);
    
    const classificacao = trans.MarcacaoIA || 'Não Classificado';
    classificacoes[classificacao] = (classificacoes[classificacao] || 0) + 1;
    
    valores.push({
        estabelecimento: trans.Estabelecimento || 'N/A',
        valor: Math.abs(valor)
    });
});

// Atualiza cards de estatísticas
document.getElementById('totalValue').textContent = 
    'R$ ' + totalValue.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});

document.getElementById('uniqueCategories').textContent = Object.keys(grupos).length;

const avgValue = transactions.length > 0 ? totalValue / transactions.length : 0;
document.getElementById('avgValue').textContent = 
    'R$ ' + avgValue.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});

// Gráfico por Grupo
const ctxGroup = document.getElementById('chartByGroup').getContext('2d');
new Chart(ctxGroup, {
    type: 'pie',
    data: {
        labels: Object.keys(grupos),
        datasets: [{
            data: Object.values(grupos),
            backgroundColor: [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF9F40'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        return label + ': R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                    }
                }
            }
        }
    }
});

// Gráfico por Classificação
const ctxClass = document.getElementById('chartByClassification').getContext('2d');
new Chart(ctxClass, {
    type: 'doughnut',
    data: {
        labels: Object.keys(classificacoes),
        datasets: [{
            data: Object.values(classificacoes),
            backgroundColor: [
                '#28a745', '#17a2b8', '#ffc107', '#6c757d', '#dc3545',
                '#007bff', '#6610f2', '#e83e8c', '#fd7e14', '#20c997'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right'
            }
        }
    }
});

// Gráfico Top 10 Maiores Valores
valores.sort((a, b) => b.valor - a.valor);
const top10 = valores.slice(0, 10);

const ctxTop = document.getElementById('chartTopValues').getContext('2d');
new Chart(ctxTop, {
    type: 'bar',
    data: {
        labels: top10.map(v => v.estabelecimento.substring(0, 30)),
        datasets: [{
            label: 'Valor (R$)',
            data: top10.map(v => v.valor),
            backgroundColor: '#007bff',
            borderColor: '#0056b3',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'R$ ' + context.parsed.x.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                    }
                }
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'R$ ' + value.toLocaleString('pt-BR');
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}
