<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Dropdown</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>üß™ Teste de Dropdowns</h1>
        
        <div class="alert alert-info">
            <strong>Objetivo:</strong> Testar se os dropdowns funcionam corretamente com os dados da base_marcacoes.
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìä Dados Carregados</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Total de grupos:</strong> {{ grupos|length }}</p>
                        <p><strong>Grupos:</strong> {{ grupos|join(', ') }}</p>
                        <p><strong>Alimenta√ß√£o tem subgrupos?</strong> 
                            {% if grupos_dict.get('Alimenta√ß√£o') %}
                                ‚úÖ Sim ({{ grupos_dict['Alimenta√ß√£o']|length }} subgrupos)
                            {% else %}
                                ‚ùå N√£o encontrado
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üéõÔ∏è Teste do Dropdown</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Selecione um Grupo:</label>
                            <select id="grupoSelect" class="form-select">
                                <option value="">-- Selecione --</option>
                                {% for grupo in grupos %}
                                <option value="{{ grupo }}">{{ grupo }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Subgrupo:</label>
                            <select id="subgrupoSelect" class="form-select">
                                <option value="">-- Primeiro selecione um grupo --</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Tipo de Gasto:</label>
                            <input type="text" id="tipoGastoInput" class="form-control" readonly placeholder="Ser√° preenchido automaticamente">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h5>üêõ Debug Console</h5>
                </div>
                <div class="card-body">
                    <div id="debugOutput" class="p-3 bg-dark text-white" style="height: 200px; overflow-y: scroll; font-family: monospace;">
                        Console de debug - selecione um grupo para ver os logs...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dados passados do Flask
        const gruposDict = {{ grupos_dict|tojson }};
        const tipoGastoDict = {{ tipo_gasto_dict|tojson }};
        
        // Fun√ß√£o para log no debug console
        function debugLog(message) {
            const debugOutput = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            debugOutput.innerHTML += `[${timestamp}] ${message}<br>`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
            console.log(message);
        }
        
        // Log inicial
        debugLog('=== TESTE DROPDOWN INICIADO ===');
        debugLog(`gruposDict carregado: ${JSON.stringify(gruposDict)}`);
        debugLog(`Total de grupos: ${Object.keys(gruposDict).length}`);
        debugLog(`Grupos dispon√≠veis: ${Object.keys(gruposDict).join(', ')}`);
        debugLog(`tipoGastoDict carregado: ${Object.keys(tipoGastoDict).length} mapeamentos`);
        
        // Verifica se Alimenta√ß√£o existe
        if ('Alimenta√ß√£o' in gruposDict) {
            debugLog(`‚úÖ Alimenta√ß√£o encontrada com ${gruposDict['Alimenta√ß√£o'].length} subgrupos: ${gruposDict['Alimenta√ß√£o'].join(', ')}`);
        } else {
            debugLog(`‚ùå PROBLEMA: Alimenta√ß√£o n√£o encontrada em gruposDict`);
        }
        
        // Event listener para o dropdown de grupo
        document.getElementById('grupoSelect').addEventListener('change', function() {
            const grupo = this.value;
            const subgrupoSelect = document.getElementById('subgrupoSelect');
            const tipoGastoInput = document.getElementById('tipoGastoInput');
            
            debugLog(`\n=== GRUPO SELECIONADO: "${grupo}" ===`);
            
            // Limpa subgrupo e tipo
            subgrupoSelect.innerHTML = '<option value="">-- Selecione um subgrupo --</option>';
            tipoGastoInput.value = '';
            
            if (grupo && gruposDict[grupo]) {
                const subgrupos = gruposDict[grupo];
                debugLog(`Subgrupos encontrados: ${JSON.stringify(subgrupos)}`);
                debugLog(`Quantidade: ${subgrupos.length}`);
                
                // Popula dropdown de subgrupos
                subgrupos.forEach((subgrupo, index) => {
                    const option = document.createElement('option');
                    option.value = subgrupo;
                    option.textContent = subgrupo;
                    subgrupoSelect.appendChild(option);
                    debugLog(`  ${index + 1}. Adicionado: "${subgrupo}"`);
                });
                
                debugLog(`‚úÖ Dropdown de subgrupo atualizado com ${subgrupos.length} op√ß√µes`);
            } else {
                debugLog(`‚ùå PROBLEMA: Grupo "${grupo}" n√£o encontrado ou sem subgrupos`);
                debugLog(`Existe no gruposDict? ${grupo in gruposDict}`);
                debugLog(`Valor de gruposDict["${grupo}"]: ${JSON.stringify(gruposDict[grupo])}`);
            }
        });
        
        // Event listener para o dropdown de subgrupo
        document.getElementById('subgrupoSelect').addEventListener('change', function() {
            const grupo = document.getElementById('grupoSelect').value;
            const subgrupo = this.value;
            const tipoGastoInput = document.getElementById('tipoGastoInput');
            
            debugLog(`\n=== SUBGRUPO SELECIONADO: "${subgrupo}" ===`);
            
            if (grupo && subgrupo) {
                const chave = `${grupo}|${subgrupo}`;
                debugLog(`Buscando tipo de gasto para chave: "${chave}"`);
                
                if (tipoGastoDict[chave]) {
                    tipoGastoInput.value = tipoGastoDict[chave];
                    debugLog(`‚úÖ Tipo de gasto encontrado: "${tipoGastoDict[chave]}"`);
                } else {
                    debugLog(`‚ùå Tipo de gasto n√£o encontrado para "${chave}"`);
                    debugLog(`Chaves dispon√≠veis: ${Object.keys(tipoGastoDict).slice(0, 5).join(', ')}...`);
                }
            }
        });
        
        debugLog('=== LISTENERS CONFIGURADOS ===');
        debugLog('Pronto para testar! Selecione um grupo...');
    </script>
</body>
</html>