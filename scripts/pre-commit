#!/usr/bin/env python3
"""
Pre-commit Git Hook - Valida√ß√£o de Versionamento

Este hook impede commits de c√≥digo em estado de desenvolvimento (-dev ou -test)
na branch principal, garantindo que apenas c√≥digo est√°vel seja versionado.

Instala√ß√£o:
    cp scripts/pre-commit .git/hooks/pre-commit
    chmod +x .git/hooks/pre-commit
"""
import sys
import re
from pathlib import Path

# Diret√≥rio raiz do projeto
PROJECT_ROOT = Path(__file__).parent.parent
VERSION_FILE = PROJECT_ROOT / "VERSION.md"
APP_INIT = PROJECT_ROOT / "app" / "__init__.py"
CHANGES_DIR = PROJECT_ROOT / "changes"


def get_current_branch():
    """Retorna nome da branch atual"""
    try:
        with open(PROJECT_ROOT / ".git" / "HEAD", 'r') as f:
            content = f.read().strip()
            if content.startswith('ref: refs/heads/'):
                return content.replace('ref: refs/heads/', '')
    except:
        pass
    return None


def check_version_status():
    """Verifica se vers√£o est√° em modo -dev ou -test"""
    
    # Verifica VERSION.md
    if VERSION_FILE.exists():
        content = VERSION_FILE.read_text()
        match = re.search(r'\*\*Vers√£o Atual:\*\* `([^`]+)`', content)
        if match:
            version = match.group(1)
            if '-dev' in version or '-test' in version:
                return False, version, "VERSION.md"
    
    # Verifica app/__init__.py
    if APP_INIT.exists():
        content = APP_INIT.read_text()
        match = re.search(r'__version__ = "([^"]+)"', content)
        if match:
            version = match.group(1)
            if '-dev' in version or '-test' in version:
                return False, version, "app/__init__.py"
    
    return True, None, None


def check_pending_changes_docs():
    """Verifica se existem mudan√ßas sem documenta√ß√£o"""
    if not CHANGES_DIR.exists():
        return True
    
    # Lista arquivos .md (exceto TEMPLATE.md)
    changes = [f for f in CHANGES_DIR.glob("*.md") if f.name != "TEMPLATE.md"]
    
    # Se h√° mudan√ßas pendentes e estamos commitando em main, alertar
    return len(changes) == 0


def main():
    """Executa valida√ß√µes do pre-commit"""
    
    # Pega branch atual
    branch = get_current_branch()
    
    # Se n√£o √© main/master, permite commit
    if branch and branch not in ['main', 'master']:
        sys.exit(0)
    
    print("\nüîç Validando commit na branch principal...\n")
    
    # Valida vers√£o
    is_valid, version, file = check_version_status()
    
    if not is_valid:
        print("‚ùå COMMIT BLOQUEADO!")
        print(f"\nüö´ Vers√£o em modo de desenvolvimento detectada: {version}")
        print(f"üìÑ Arquivo: {file}")
        print("\n‚ö†Ô∏è  N√£o √© permitido commitar c√≥digo com vers√£o -dev ou -test na branch principal.")
        print("\n‚úÖ Para corrigir:")
        print(f"   1. Finalize a mudan√ßa: python scripts/version_manager.py finish <arquivo> \"descri√ß√£o\"")
        print(f"   2. Ou use --no-verify (n√£o recomendado): git commit --no-verify")
        print(f"   3. Ou commit em branch de desenvolvimento")
        print()
        sys.exit(1)
    
    # Avisa sobre mudan√ßas pendentes
    if not check_pending_changes_docs():
        print("‚ö†Ô∏è  AVISO: Existem arquivos em changes/ que n√£o foram inclu√≠dos em release")
        print("   Considere rodar: python scripts/version_manager.py release patch")
        print()
    
    print("‚úÖ Valida√ß√£o passou! Prosseguindo com commit...\n")
    sys.exit(0)


if __name__ == '__main__':
    main()
