{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/emangue/Documents/ProjetoVSCode/ProjetoFinancasV3/app_dev/src/app/api/dashboard/chart-data/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport Database from 'better-sqlite3';\nimport path from 'path';\n\nexport async function GET(req: NextRequest) {\n  try {\n    const { searchParams } = new URL(req.url);\n    const year = searchParams.get('year') || '2025';\n    const month = searchParams.get('month') || 'all';\n\n    const dbPath = path.join(process.cwd(), 'financas_dev.db');\n    const db = new Database(dbPath);\n\n    let whereClause = '';\n    if (month !== 'all') {\n      // Se um mês específico for selecionado, mostrar últimos 6 meses incluindo esse\n      const selectedMonth = `${year}${month.padStart(2, '0')}`;\n      whereClause = `WHERE MesFatura <= '${selectedMonth}' AND MesFatura > '${(parseInt(year) - 1).toString()}${month.padStart(2, '0')}'`;\n    } else {\n      // Se \"todos os meses\", mostrar todos os meses do ano\n      whereClause = `WHERE MesFatura LIKE '${year}%'`;\n    }\n\n    // Buscar dados dos últimos meses\n    const chartData = db.prepare(`\n      SELECT \n        MesFatura,\n        TipoTransacao,\n        SUM(ValorPositivo) as valor\n      FROM journal_entries\n      ${whereClause} \n        AND MesFatura IS NOT NULL\n        AND IgnorarDashboard = 0\n      GROUP BY MesFatura, TipoTransacao\n      ORDER BY MesFatura\n    `).all() as Array<{ MesFatura: string; TipoTransacao: string; valor: number }>;\n\n    // Transformar dados para o formato do gráfico\n    const chartMap = new Map<string, { receitas: number; despesas: number; mesFormatado: string }>();\n\n    chartData.forEach(item => {\n      const mes = item.MesFatura;\n      if (!chartMap.has(mes)) {\n        // Formatar mês (AAAAMM -> MMM/AAAA)\n        const year = mes.substring(0, 4);\n        const month = mes.substring(4, 6);\n        const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', \n                           'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];\n        const mesFormatado = `${monthNames[parseInt(month) - 1]}/${year}`;\n        \n        chartMap.set(mes, { receitas: 0, despesas: 0, mesFormatado });\n      }\n\n      const data = chartMap.get(mes)!;\n      if (item.TipoTransacao === 'Receitas') {\n        data.receitas = item.valor;\n      } else if (['Despesas', 'Cartão de Crédito'].includes(item.TipoTransacao)) {\n        data.despesas += item.valor;\n      }\n    });\n\n    // Converter para array e ordenar\n    const chartArray = Array.from(chartMap.entries())\n      .map(([mes, data]) => ({\n        mes: data.mesFormatado,\n        receitas: data.receitas,\n        despesas: data.despesas\n      }))\n      .sort((a, b) => {\n        // Extrair ano e mês para ordenação\n        const [mesA, anoA] = a.mes.split('/');\n        const [mesB, anoB] = b.mes.split('/');\n        const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', \n                           'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];\n        \n        const mesNumA = monthNames.indexOf(mesA) + 1;\n        const mesNumB = monthNames.indexOf(mesB) + 1;\n        \n        if (anoA !== anoB) return anoA.localeCompare(anoB);\n        return mesNumA - mesNumB;\n      });\n\n    db.close();\n\n    return NextResponse.json(chartArray);\n  } catch (error) {\n    console.error('Error fetching chart data:', error);\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });\n  }\n}"],"names":[],"mappings":"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"}}]
}