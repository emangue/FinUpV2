{% extends "base.html" %}

{% block title %}Admin - Logos de Estabelecimentos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-images"></i> Administração de Logos</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalLogo">
        <i class="fas fa-upload"></i> Upload Logo
    </button>
</div>

<div class="alert alert-info">
    <i class="fas fa-info-circle"></i> Faça upload de logos para estabelecimentos específicos (Uber, iFood, Z Deli, etc). As imagens aparecerão nas transações ao invés dos ícones padrão.
    <br><small><strong>Formatos aceitos:</strong> PNG, JPG, GIF, SVG, WebP (máx 2MB)</small>
</div>

<!-- Lista de Logos -->
<div class="row">
    {% for logo in logos %}
    <div class="col-md-6 col-lg-4 col-xl-3 mb-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="mb-3" style="height: 80px; display: flex; align-items: center; justify-content: center;">
                    <img src="/static/logos/{{ logo.arquivo_logo }}" 
                         alt="{{ logo.nome_exibicao }}" 
                         style="max-width: 100%; max-height: 80px; object-fit: contain;">
                </div>
                <h6 class="card-title">{{ logo.nome_exibicao }}</h6>
                <p class="card-text small text-muted">
                    Busca: 
                    {% set palavras = logo.nome_busca.split(',') %}
                    {% for palavra in palavras %}
                        <code>{{ palavra.strip() }}</code>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                </p>
                {% if logo.ativo %}
                <span class="badge bg-success mb-2">Ativo</span>
                {% else %}
                <span class="badge bg-secondary mb-2">Inativo</span>
                {% endif %}
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-primary w-100 mb-2" 
                            onclick="editarLogo({{ logo.id }}, '{{ logo.nome_busca }}', '{{ logo.nome_exibicao }}', '{{ logo.arquivo_logo }}')">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-sm btn-outline-danger w-100" onclick="deletarLogo({{ logo.id }}, '{{ logo.nome_exibicao }}')">
                        <i class="fas fa-trash"></i> Deletar
                    </button>
                </div>
            </div>
            <div class="card-footer text-muted small">
                <i class="far fa-clock"></i> {{ logo.created_at.strftime('%d/%m/%Y') if logo.created_at else 'N/A' }}
            </div>
        </div>
    </div>
    {% endfor %}
    
    {% if not logos %}
    <div class="col-12">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> Nenhum logo cadastrado. Clique em "Upload Logo" para adicionar.
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Upload Logo -->
<div class="modal fade" id="modalLogo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-upload"></i> Adicionar Novo Logo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formLogo" onsubmit="uploadLogo(event)" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nome(s) para Busca *</label>
                        <input type="text" class="form-control" name="nome_busca" required>
                        <small class="text-muted">
                            Ex: "uber, uber eats" ou "ifood" ou "z deli, zdeli" - Separe múltiplas palavras por vírgula
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Nome para Exibição</label>
                        <input type="text" class="form-control" name="nome_exibicao">
                        <small class="text-muted">
                            Ex: "Uber", "iFood", "Z Deli" - Como deve aparecer formatado
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Arquivo do Logo *</label>
                        <input type="file" class="form-control" name="logo_file" 
                               accept=".png,.jpg,.jpeg,.gif,.svg,.webp" required>
                        <small class="text-muted">PNG, JPG, GIF, SVG ou WebP (máx 2MB)</small>
                    </div>
                    
                    <div id="mensagemModal"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnUpload">
                        <i class="fas fa-upload"></i> Upload
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Logo -->
<div class="modal fade" id="modalEditarLogo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Editar Logo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formEditarLogo" onsubmit="atualizarLogo(event)" enctype="multipart/form-data">
                <input type="hidden" id="edit_logo_id" name="edit_logo_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nome(s) para Busca *</label>
                        <input type="text" class="form-control" id="edit_nome_busca" name="nome_busca" required>
                        <small class="text-muted">
                            Ex: "uber, uber eats" ou "ifood" ou "z deli, zdeli" - Separe múltiplas palavras por vírgula
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Nome para Exibição</label>
                        <input type="text" class="form-control" id="edit_nome_exibicao" name="nome_exibicao">
                        <small class="text-muted">
                            Ex: "Uber", "iFood", "Z Deli" - Como deve aparecer formatado
                        </small>
                    </div>
                    
                    <div class="text-center mb-3">
                        <div class="p-3 border rounded">
                            <p class="text-muted small mb-2">Logo Atual:</p>
                            <img id="edit_logo_atual" src="" style="max-width: 100%; max-height: 100px; border-radius: 50%;">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Novo Arquivo do Logo (opcional)</label>
                        <input type="file" class="form-control" name="logo_file" 
                               accept=".png,.jpg,.jpeg,.gif,.svg,.webp">
                        <small class="text-muted">Deixe em branco para manter o logo atual. PNG, JPG, GIF, SVG ou WebP (máx 2MB)</small>
                    </div>
                    
                    <div id="mensagemModalEditar"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="btnAtualizar">
                        <i class="fas fa-save"></i> Atualizar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Upload de NOVO logo
function uploadLogo(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const btnUpload = document.getElementById('btnUpload');
    
    btnUpload.disabled = true;
    btnUpload.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
    
    fetch('/admin/logos/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            document.getElementById('mensagemModal').innerHTML = 
                `<div class="alert alert-danger">${data.error}</div>`;
            btnUpload.disabled = false;
            btnUpload.innerHTML = '<i class="fas fa-upload"></i> Upload';
        }
    })
    .catch(error => {
        document.getElementById('mensagemModal').innerHTML = 
            `<div class="alert alert-danger">Erro ao fazer upload: ${error}</div>`;
        btnUpload.disabled = false;
        btnUpload.innerHTML = '<i class="fas fa-upload"></i> Upload';
    });
}

// Abrir modal de edição
function editarLogo(id, nomeBusca, nomeExibicao, arquivoLogo) {
    // Preencher campos com dados atuais
    document.getElementById('edit_logo_id').value = id;
    document.getElementById('edit_nome_busca').value = nomeBusca;
    document.getElementById('edit_nome_exibicao').value = nomeExibicao;
    document.getElementById('edit_logo_atual').src = `/static/logos/${arquivoLogo}`;
    
    // Limpar mensagens e arquivo
    document.getElementById('mensagemModalEditar').innerHTML = '';
    document.querySelector('#formEditarLogo input[type="file"]').value = '';
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalEditarLogo'));
    modal.show();
}

// Atualizar logo existente
function atualizarLogo(event) {
    event.preventDefault();
    
    const logoId = document.getElementById('edit_logo_id').value;
    const formData = new FormData(event.target);
    const btnAtualizar = document.getElementById('btnAtualizar');
    
    btnAtualizar.disabled = true;
    btnAtualizar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Atualizando...';
    
    fetch(`/admin/logos/update/${logoId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            document.getElementById('mensagemModalEditar').innerHTML = 
                `<div class="alert alert-danger">${data.error}</div>`;
            btnAtualizar.disabled = false;
            btnAtualizar.innerHTML = '<i class="fas fa-save"></i> Atualizar';
        }
    })
    .catch(error => {
        document.getElementById('mensagemModalEditar').innerHTML = 
            `<div class="alert alert-danger">Erro ao atualizar: ${error}</div>`;
        btnAtualizar.disabled = false;
        btnAtualizar.innerHTML = '<i class="fas fa-save"></i> Atualizar';
    });
}

// Deletar logo
function deletarLogo(id, nome) {
    if (!confirm(`Tem certeza que deseja deletar o logo de "${nome}"?`)) {
        return;
    }
    
    fetch(`/admin/logos/deletar/${id}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erro ao deletar: ' + data.error);
        }
    })
    .catch(error => {
        alert('Erro ao deletar: ' + error);
    });
}
</script>
{% endblock %}
