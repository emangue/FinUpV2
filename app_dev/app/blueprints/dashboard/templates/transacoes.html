{% extends "base.html" %}

{% block title %}Transações - {{ mes_exibicao }}{% endblock %}

{% block extra_css %}
<style>
    #dataTable tbody tr {
        height: 40px;
    }
    #dataTable tbody td {
        padding: 0.4rem 0.75rem;
        vertical-align: middle;
        line-height: 1.2;
    }
    #dataTable thead th {
        padding: 0.5rem 0.75rem;
    }
    .table-responsive {
        font-size: 0.9rem;
    }
    .badge {
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">Transações de {{ mes_exibicao }}</h1>
            <p class="text-muted mb-0">{{ total_transacoes }} transações encontradas</p>
        </div>
        <button type="button" onclick="voltarDashboard(event)" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar ao Dashboard
        </button>
    </div>

    <!-- ============================================ -->
    <!-- COMPONENTE COMPARTILHADO: Filtros de Transações -->
    <!-- ============================================ -->
    {% include '_macros/transacao_filters.html' %}

    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="dataTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Estabelecimento</th>
                            <th>Grupo</th>
                            <th>Subgrupo</th>
                            <th>Valor</th>
                            <th>Tipo</th>
                            <th>Status Dashboard</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trans in transacoes %}
                        <tr onclick="abrirModalEditar({{ trans.id }})" style="cursor: pointer;" title="Clique para editar">
                            <td data-sort="{{ trans.Data|replace('/', '-') }}">{{ trans.Data }}</td>
                            <td>
                                <span class="text-truncate">{{ trans.Estabelecimento }}</span>
                            </td>
                            <td>
                                {% if trans.GRUPO %}
                                    <span class="badge" style="background-color: {{ trans.GRUPO|get_group_color }}; color: white;">
                                        <i class="fas {{ trans.GRUPO|get_group_icon }} me-1"></i>
                                        {{ trans.GRUPO }}
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">Não classificado</span>
                                {% endif %}
                            </td>
                            <td>{{ trans.SUBGRUPO or '-' }}</td>
                            <td class="{{ 'text-danger' if trans.Valor < 0 else 'text-success' }} fw-bold">
                                {{ trans.Valor|format_currency }}
                            </td>
                            <td>
                                {% if trans.TipoTransacao == 'Cartão de Crédito' %}
                                    Cartão
                                {% elif trans.TipoTransacao == 'Conta Corrente' %}
                                    C/C
                                {% else %}
                                    {{ trans.TipoTransacao }}
                                {% endif %}
                            </td>
                            <td onclick="event.stopPropagation();">
                                <div class="form-check form-switch">
                                    <input class="form-check-input toggle-dashboard" type="checkbox" 
                                           id="switch_{{ trans.IdTransacao }}" 
                                           data-id="{{ trans.IdTransacao }}"
                                           {% if not trans.IgnorarDashboard %}checked{% endif %}>
                                    <label class="form-check-label" for="switch_{{ trans.IdTransacao }}">
                                        {% if trans.IgnorarDashboard %}
                                            <span class="badge bg-secondary"><i class="fas fa-eye-slash"></i> Ignorado</span>
                                        {% else %}
                                            <span class="badge bg-success"><i class="fas fa-check"></i> Considerado</span>
                                        {% endif %}
                                    </label>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- COMPONENTE COMPARTILHADO: Modal de Edição -->
<!-- ============================================ -->
{% include '_macros/transacao_modal_edit.html' %}
{% endblock %}

{% block scripts %}
<script>
/**
 * Retorna ao dashboard preservando o mês que estava sendo visualizado antes
 */
function voltarDashboard(event) {
    event.preventDefault();
    
    // Recuperar mês original do dashboard (se foi salvo)
    const mesOriginal = sessionStorage.getItem('dashboardMesOriginal');
    
    if (mesOriginal) {
        // Voltar para o mês que estava visualizando antes
        window.location.href = `/dashboard/?mes=${mesOriginal}`;
        // Limpar sessão após uso
        sessionStorage.removeItem('dashboardMesOriginal');
    } else {
        // Se não tem mês salvo, voltar sem parâmetro (vai para o mês atual)
        window.location.href = '/dashboard/';
    }
}
</script>

<script>
    $(document).ready(function() {
        var table = $('#dataTable').DataTable({
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Portuguese-Brasil.json"
            },
            "order": [[ 0, "desc" ]],
            "pageLength": 50
        });

        // Handler para o toggle switch
        $(document).on('change', '.toggle-dashboard', function() {
            console.log('Toggle clicado!');
            
            var checkbox = $(this);
            // Usa .attr() em vez de .data() para evitar conversão automática de números grandes (64-bit ints)
            var idTransacao = checkbox.attr('data-id');
            var isChecked = checkbox.is(':checked');
            var label = checkbox.next('label');
            
            console.log('ID Transacao:', idTransacao);
            console.log('Is Checked:', isChecked);
            
            // Se está checked, IgnorarDashboard deve ser False (Considerado)
            // Se não está checked, IgnorarDashboard deve ser True (Ignorado)
            var ignorar = !isChecked;

            // Desabilita enquanto processa
            checkbox.prop('disabled', true);

            $.ajax({
                url: '/api/transacoes/toggle_dashboard/' + idTransacao,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ ignorar: ignorar }),
                success: function(response) {
                    console.log('Response:', response);
                    if (response.success) {
                        // Atualiza a label visualmente
                        if (isChecked) {
                            label.html('<span class="badge bg-success"><i class="fas fa-check"></i> Considerado</span>');
                        } else {
                            label.html('<span class="badge bg-secondary"><i class="fas fa-eye-slash"></i> Ignorado</span>');
                        }
                        
                        // Mostra feedback
                        if (typeof Swal !== 'undefined') {
                            const Toast = Swal.mixin({
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 2000,
                                timerProgressBar: true
                            });
                            
                            Toast.fire({
                                icon: 'success',
                                title: isChecked ? 'Transação incluída no dashboard' : 'Transação removida do dashboard'
                            });
                        } else {
                            alert(isChecked ? 'Transação incluída no dashboard' : 'Transação removida do dashboard');
                        }
                    }
                },
                error: function(xhr) {
                    console.error('Erro AJAX:', xhr);
                    // Reverte em caso de erro
                    checkbox.prop('checked', !isChecked);
                    alert('Erro ao atualizar status: ' + (xhr.responseJSON?.error || 'Erro desconhecido'));
                },
                complete: function() {
                    checkbox.prop('disabled', false);
                }
            });
        });
    });
    
    // As funções abrirModalEditar() e salvarEdicaoTransacao() estão definidas
    // no componente compartilhado '_macros/transacao_modal_edit.html'
</script>
{% endblock %}
